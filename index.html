<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1a2a6c">
<link rel="apple-touch-icon" href="ChatGPT Image Oct 5, 2025, 12_37_25 AM.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GTT">
<title>郭彤彤</title>
<link href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/lxgwwenkai-regular.min.css" rel="stylesheet">
<link rel="preload" as="audio" href="coin-flip-shimmer-85750.mp3" type="audio/mpeg">

<style>
  /* === iOS-compatible dimming overlay === */
  #dim-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 800;
    pointer-events: none;
  }
  
  body.raining #dim-overlay {
    opacity: 1;
  }
  
  #splash-particles {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 9998;
  pointer-events: none;
  opacity: 0.4;
  }
  /* Reset */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  /* Background fix for iOS */
  html {
    height: 100%;
    width: 100%;
    background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    margin: 0;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  body {
    height: 100%;
    width: 100%;
    background: transparent !important;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'LXGW WenKai', 'Inter', 'PingFang SC', sans-serif;
    overflow: hidden;
    margin: 0;
    -webkit-touch-callout: none;
    -webkit-text-size-adjust: 100%;
  }

  /* Frosted panel */
  .container {
    text-align: center;
    max-width: 350px;
    width: 100%;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 20px;
    padding: 30px 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.08);
    position: relative;
    z-index: 1;
  }
  .container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
    z-index: -1;
  }

  /* Game button */
  .game-btn {
    position: absolute;
    top: 10px;
    left: 12px;
    background: transparent;
    border: none;
    padding: 6px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .game-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.05);
  }
  .game-btn svg {
    transition: opacity 0.25s ease;
  }
  .game-btn.active {
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
  }

  .mute-btn {
    position: absolute;
    top: 10px;
    right: 12px;
    background: transparent;
    border: none;
    padding: 6px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .mute-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.05);
  }
  .mute-btn svg {
    transition: opacity 0.25s ease;
  }
  .mute-btn.active {
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
  }

  .effect-btn {
  position: absolute;
  top: 10px;
  right: 50px; /* sits left of mute button */
  background: transparent;
  border: none;
  padding: 6px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.25s ease;
  -webkit-tap-highlight-color: transparent;
  }
  .effect-btn:hover {
  background: rgba(255, 255, 255, 0.12);
  transform: scale(1.05);
  }
  .effect-btn.active {
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
  }

  /* Creamy glowy text */
  h1,
  .subtitle,
  .result-text,
  .stat-value,
  .stat-label,
  .coin-letter {
    color: #fff8e7;
    text-shadow: 0 0 2px rgba(255, 248, 231, 0.3),
                 0 0 4px rgba(255, 248, 231, 0.2),
                 0 0 6px rgba(255, 248, 231, 0.15);
  }
  .subtitle,
  .stat-label {
    text-shadow: 0 0 1px rgba(255, 248, 231, 0.2);
  }

  /* Subtitle */
  .subtitle {
    font-size: 1rem;
    margin-bottom: 25px;
    line-height: 1.5;
    font-weight: 300;
  }

  /* Enhanced Coin Design */
  .coin-container {
    perspective: 1000px;
    width: 150px;
    height: 150px;
    margin: 0 auto 20px;
    position: relative;
  }
  .coin {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 1.5s ease-in-out;
  }
  .coin.flipping {
    animation: flip 1.5s ease-in-out;
  }
  .coin-face {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 3.5rem;
    font-weight: bold;
    overflow: hidden;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    
    /* Enhanced metallic look with better shine */
    background: radial-gradient(circle at 30% 30%, 
                #f9f9f9 0%, 
                #e8e8e8 15%, 
                #c9c9c9 40%, 
                #a8a8a8 70%, 
                #8a8a8a 100%);
    border: 6px solid #d4d4d4;
    
    /* Enhanced shadows for more depth */
    box-shadow:
      0 12px 30px rgba(0, 0, 0, 0.4),
      inset 0 -10px 20px rgba(0, 0, 0, 0.5),
      inset 0 10px 20px rgba(255, 255, 255, 0.6);
  }

  /* Enhanced gleam effect */
  .coin-face::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, 
                rgba(255, 255, 255, 0.8) 0%, 
                rgba(255, 255, 255, 0.4) 20%, 
                rgba(255, 255, 255, 0.2) 40%, 
                transparent 70%);
    z-index: 1;
    pointer-events: none;
  }

  .coin-face::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg, 
                rgba(255, 255, 255, 0.8) 0deg,
                rgba(255, 255, 255, 0.4) 60deg,
                rgba(255, 255, 255, 0.2) 120deg,
                rgba(255, 255, 255, 0.1) 180deg,
                rgba(255, 255, 255, 0.2) 240deg,
                rgba(255, 255, 255, 0.4) 300deg,
                rgba(255, 255, 255, 0.8) 360deg);
    opacity: 0.6;
    animation: spinGleam 4s linear infinite;
    pointer-events: none;
    border-radius: 50%;
    z-index: 2;
  }

  @keyframes spinGleam {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .coin-front {
    transform: rotateY(0deg);
    z-index: 2;
  }
  .coin-back {
    transform: rotateY(180deg);
  }
  .coin-image-container {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    z-index: 3;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3);
  }
  .coin-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Fallback coin design if images don't load */
  .coin-fallback {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    font-size: 2.5rem;
    color: #1a2a6c;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }

  /* Result */
  .result {
    font-size: 1.8rem;
    margin: 20px 0;
    min-height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .result-text {
    background: rgba(255, 255, 255, 0.15);
    padding: 10px 20px;
    border-radius: 50px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }
  .result-text.celebrate {
    animation: celebrate 0.5s ease;
    background: rgba(255, 255, 255, 0.25);
  }

  /* Button */
  button {
    background: linear-gradient(to right, #fff, #f0f0f0);
    color: #1a2a6c;
    border: none;
    padding: 12px 35px;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
    letter-spacing: 0.5px;
    -webkit-tap-highlight-color: transparent;
  }
  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
  }
  button:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
  }
  button:hover::before {
    left: 100%;
  }
  button:active {
    transform: translateY(1px);
  }
  button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  /* Stats */
  .stats {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
    background: rgba(255, 255, 255, 0.08);
    padding: 15px;
    border-radius: 18px;
    width: 100%;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  .stat {
    text-align: center;
    position: relative;
    padding: 0 10px;
  }
  .stat::after {
    content: '';
    position: absolute;
    right: 0;
    top: 20%;
    height: 60%;
    width: 1px;
    background: rgba(255, 255, 255, 0.2);
  }
  .stat:last-child::after {
    display: none;
  }
  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
    letter-spacing: 0.5px;
  }

  /* Floating emojis */
  .floating-emojis {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 0;
    opacity: 0.7;
  }
  .emoji {
    position: absolute;
    font-size: 24px;
    opacity: 0;
    animation: float 8s linear infinite;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
  }
  .emoji:nth-child(3n) { animation-duration: 10s; }
  .emoji:nth-child(3n+1) { animation-duration: 12s; }
  .emoji:nth-child(3n+2) { animation-duration: 14s; }

  /* Animations */
  @keyframes flip {
    0% { transform: rotateY(0); }
    50% { transform: rotateY(1800deg); }
    100% { transform: rotateY(1980deg); }
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  @keyframes float {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 0.8; }
    90% { opacity: 0.8; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
  }
  @keyframes celebrate {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  /* Mobile adjustments */
  @media (max-width: 500px) {
    .container { padding: 25px 15px; }
    h1 { font-size: 2rem; }
    .coin-container { width: 120px; height: 120px; }
    .coin-face { font-size: 2.5rem; }
    .stats { padding: 10px; }
    .stat-value { font-size: 1.6rem; }
    .emoji { font-size: 18px; }
    #game-app :root { --cell-size: 24px; }
  }
  
  /* === Confetti animation === */
  .confetti {
    position: fixed;
    width: 10px;
    height: 14px;
    opacity: 0.9;
    border-radius: 2px;
    z-index: 9999;
    animation: confettiFall 3s ease-out forwards;
  }
  @keyframes confettiFall {
    0% {
      transform: translateY(-10vh) translateX(0) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(110vh) translateX(var(--xShift)) rotate(720deg);
      opacity: 0;
    }
  }

  /* === Raindrops (reverted to original) === */
  .raindrop {
    position: fixed;
    top: -20px;
    width: 2px;
    height: 18px;
    background: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0));
    border-radius: 1px;
    opacity: 0.7;
    z-index: 950;
    animation: fall 1.2s linear infinite;
  }
  @keyframes fall {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(100vh); opacity: 0; }
  }

  /* === Game App Styles === */
  #game-app {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: none;
    background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  
  #game-app .app {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    justify-content: center;
    width: 100%;
    max-width: 1100px;
    padding: 12px;
    margin: 0 auto;
    height: 100%;
  }
  
  #game-app .panel {
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 10px;
    box-shadow: 0 14px 30px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.06);
    color: #fff8e7;
  }
  
  #game-app .controls {
    width: 220px;
    min-width: 160px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }
  
  #game-app label { 
    font-size: 13px; 
    color: rgba(255,255,255,0.9); 
    display: block; 
  }
  
  #game-app input[type="text"], 
  #game-app input[type="tel"], 
  #game-app input {
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.03);
    color: #fff8e7;
    font-size: 16px;
    outline: none;
  }
  
  #game-app .btn-row { 
    display: flex; 
    gap: 8px; 
  }
  
  #game-app button {
    padding: 8px 12px;
    font-size: 13px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(240,240,240,0.95));
    color: #12213a;
    box-shadow: 0 6px 16px rgba(0,0,0,0.22);
    transition: transform .12s ease, box-shadow .12s ease;
    flex: 1 1 auto;
  }
  
  #game-app button.small {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 8px;
  }
  
  #game-app button:active { 
    transform: translateY(1px); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
  }
  
  #game-app button:disabled { 
    opacity: 0.6; 
    cursor: not-allowed; 
    transform: none; 
    box-shadow: none; 
  }
  
  #game-app .board-panel {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  
  #game-app .board-container {
    position: relative;
    width: calc(var(--cell-size) * (var(--board-size) - 1));
    height: calc(var(--cell-size) * (var(--board-size) - 1));
    background-color: var(--board-color);
    margin: 0 auto;
    border-radius: 6px;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
  }
  
  #game-app .grid-lines, 
  #game-app .intersections {
    position: absolute;
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
  }
  
  #game-app .grid-line { 
    position: absolute; 
    background-color: var(--grid-color); 
  }
  
  #game-app .grid-line.horizontal { 
    width: 100%; 
    height: 1px; 
  }
  
  #game-app .grid-line.vertical { 
    height: 100%; 
    width: 1px; 
  }
  
  #game-app .intersections {
    display: grid;
    grid-template-columns: repeat(var(--board-size), var(--cell-size));
    grid-template-rows: repeat(var(--board-size), var(--cell-size));
    margin-left: calc(var(--cell-size) / -2);
    margin-top: calc(var(--cell-size) / -2);
  }
  
  #game-app .intersection {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.08s ease;
  }
  
  #game-app .intersection:hover:not(.disabled) { 
    transform: scale(1.1); 
  }
  
  #game-app .intersection.disabled { 
    pointer-events: none; 
    opacity: 0.95; 
  }
  
  #game-app .stone {
    width: calc(var(--cell-size) * 0.82);
    height: calc(var(--cell-size) * 0.82);
    border-radius: 50%;
    z-index: 2;
    box-shadow: inset 0 -6px 12px rgba(0,0,0,0.25), 0 2px 6px rgba(0,0,0,0.18);
  }
  
  #game-app .stone.black { 
    background: radial-gradient(circle at 30% 30%, #444, #000); 
  }
  
  #game-app .stone.white { 
    background: radial-gradient(circle at 30% 30%, #fff, #ccc); 
  }
  
  #game-app .star-point {
    position: absolute;
    width: var(--star-point-size);
    height: var(--star-point-size);
    background: #000;
    border-radius: 50%;
    z-index: 1;
  }
  
  #game-app .status-row { 
    display: flex; 
    gap: 10px; 
    align-items: center; 
    font-size: 13px; 
    color: rgba(255,255,255,0.95); 
  }
  
  #game-app .muted { 
    color: rgba(255,255,255,0.78); 
    font-size: 12px; 
  }
  
  #game-app #toast {
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%) translateY(8px);
    padding: 10px 14px;
    border-radius: 12px;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    border: 1px solid rgba(255,255,255,0.12);
    color: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    opacity: 0;
    pointer-events: none;
    transition: opacity .36s ease, transform .36s ease;
    z-index: 9999;
  }
  
  #game-app #toast.show { 
    opacity: 1; 
    transform: translateX(-50%) translateY(0); 
    pointer-events: auto; 
  }
  
  @media (max-width: 900px) {
    #game-app .app { 
      flex-direction: column; 
      align-items: center; 
      gap: 12px; 
      padding: 8px; 
    }
    
    #game-app .controls { 
      width: 100%; 
      max-width: 420px; 
    }
    
    #game-app .panel { 
      width: 100%; 
      max-width: 420px; 
    }
  }
  
  @media (max-width: 420px) {
    #game-app :root { 
      --star-point-size: 3px; 
    }
    
    #game-app .controls { 
      gap: 8px; 
    }
    
    #game-app input, 
    #game-app button { 
      font-size: 13px; 
    }
  }
  
  /* Back button for game */
  .back-btn {
    position: fixed;
    top: 10px;
    left: 12px;
    background: transparent;
    border: none;
    padding: 6px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s ease;
    -webkit-tap-highlight-color: transparent;
    z-index: 1001;
  }
  
  .back-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.05);
  }
  
  /* Game controls in game app */
  .game-controls {
    position: fixed;
    top: 10px;
    right: 12px;
    display: flex;
    gap: 8px;
    z-index: 1001;
  }
  
  .game-controls .mute-btn,
  .game-controls .effect-btn {
    position: static;
  }
</style>
</head>

<body>
<div id="dim-overlay"></div>
<canvas id="splash-particles"></canvas>
<div class="container">
  <!-- Game Button -->
  <button class="game-btn" id="game-btn" aria-label="Play Gomoku game">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="3" y1="9" x2="21" y2="9"></line>
      <line x1="9" y1="21" x2="9" y2="9"></line>
    </svg>
  </button>

  <!-- Effect Toggle Button -->
  <button class="effect-btn" id="effect-btn" aria-label="Toggle visual effects">
    <!-- Cloud OFF (outline) -->
    <svg id="effect-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         width="22" height="22" style="display:block;">
      <path d="M17.5 19a4.5 4.5 0 0 0 0-9 5.5 5.5 0 0 0-10.9 1A4 4 0 0 0 7 19h10.5z"/>
    </svg>

    <!-- Cloud ON (filled + glow) -->
    <svg id="effect-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         fill="#fff8e7" stroke="#fff8e7" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
         width="22" height="22" style="display:none; filter: drop-shadow(0 0 6px rgba(255,255,255,0.8));">
      <path d="M17.5 19a4.5 4.5 0 0 0 0-9 5.5 5.5 0 0 0-10.9 1A4 4 0 0 0 7 19h10.5z"/>
    </svg>
  </button>

  <button class="mute-btn" id="mute-btn" aria-label="Toggle sound">
    
    <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22" style="display:none;">
      <path d="M11 5L6 9H2V15H6L11 19V5Z" />
      <line x1="23" y1="9" x2="17" y2="15" />
      <line x1="17" y1="9" x2="23" y2="15" />
    </svg>
    
    <svg id="unmute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22" style="display:block;">
      <path d="M11 5L6 9H2V15H6L11 19V5Z" />
      <path d="M15.54 8.46C16.4774 9.39764 17.004 10.6692 17.004 12C17.004 13.3308 16.4774 14.6024 15.54 15.54" />
      <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" />
    </svg>
    
  </button>
  

  <h1>欢迎小宝宝！</h1>
  <p class="subtitle">
    这只是一件平常的小事，并不会决定你的运气宝宝。但如果它能给你一点点激励，那就是我最大的心愿。
    不管怎样，你永远是最棒的郭彤彤。我爱你。
  </p>

  <div class="coin-container">
    <div class="coin" id="coin">
      <div class="coin-face coin-front">
        <div class="coin-image-container">
          <img src="A.png" class="coin-image" alt="A Side" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="coin-fallback" style="display:none;">A</div>
        </div>
      </div>
      <div class="coin-face coin-back">
        <div class="coin-image-container">
          <img src="B.png" class="coin-image" alt="B Side" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="coin-fallback" style="display:none;">B</div>
        </div>
      </div>
    </div>
  </div>

  <div class="result">
    <div class="result-text" id="result">宝宝开始吧！</div>
  </div>
  <button id="flip-button">翻转硬币</button>

  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="a-count">0</div>
      <div class="stat-label">A面次数</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="total-count">0</div>
      <div class="stat-label">总次数</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="b-count">0</div>
      <div class="stat-label">B面次数</div>
    </div>
  </div>
</div>

<div class="floating-emojis" id="emojis-container"></div>

<!-- Game App (Hidden by default) -->
<div id="game-app">
  <button class="back-btn" id="back-btn" aria-label="Go back to coin app">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
      <line x1="19" y1="12" x2="5" y2="12"></line>
      <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
  </button>
  
  <div class="game-controls">
    <button class="effect-btn" id="game-effect-btn" aria-label="Toggle visual effects">
      <svg id="game-effect-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
           width="22" height="22" style="display:block;">
        <path d="M17.5 19a4.5 4.5 0 0 0 0-9 5.5 5.5 0 0 0-10.9 1A4 4 0 0 0 7 19h10.5z"/>
      </svg>
      <svg id="game-effect-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           fill="#fff8e7" stroke="#fff8e7" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
           width="22" height="22" style="display:none; filter: drop-shadow(0 0 6px rgba(255,255,255,0.8));">
        <path d="M17.5 19a4.5 4.5 0 0 0 0-9 5.5 5.5 0 0 0-10.9 1A4 4 0 0 0 7 19h10.5z"/>
      </svg>
    </button>

    <button class="mute-btn" id="game-mute-btn" aria-label="Toggle sound">
      <svg id="game-mute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22" style="display:none;">
        <path d="M11 5L6 9H2V15H6L11 19V5Z" />
        <line x1="23" y1="9" x2="17" y2="15" />
        <line x1="17" y1="9" x2="23" y2="15" />
      </svg>
      <svg id="game-unmute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#fff8e7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22" style="display:block;">
        <path d="M11 5L6 9H2V15H6L11 19V5Z" />
        <path d="M15.54 8.46C16.4774 9.39764 17.004 10.6692 17.004 12C17.004 13.3308 16.4774 14.6024 15.54 15.54" />
        <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" />
      </svg>
    </button>
  </div>

  <div class="app" id="appRoot">
    <!-- Controls Panel -->
    <div class="panel controls" id="controlsPanel">
      <label for="roomId">Room code</label>
      <input id="roomId" placeholder="Create or paste room code" type="text" autocomplete="off" inputmode="text" />
      <div class="btn-row" id="initialButtons">
        <button id="createBtn" class="small">Create Room</button>
        <button id="joinBtn" class="small">Join Room</button>
      </div>

      <!-- shown only when in-room -->
      <div class="btn-row" id="inRoomButtons" style="display:none">
        <button id="resetBtn" class="small">Reset Board</button>
        <button id="leaveBtn" class="small">Leave Room</button>
      </div>

      <div style="height:6px"></div>
      <div class="status-row">
        <div id="status">Not connected</div>
      </div>
      <div style="height:6px"></div>
      <div class="muted" id="players">Players: -</div>
      <div style="height:8px"></div>
      <div class="muted" id="turnIndicator">Turn: —</div>
      <div class="muted" id="youIndicator">You: —</div>
    </div>

    <!-- Board Panel -->
    <div class="panel board-panel" id="boardPanel">
      <div class="board-container" id="boardContainer">
        <div class="grid-lines" id="gridLines"></div>
        <div class="intersections" id="board"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>
</div>

<audio id="flip-sound" preload="auto">
  <source src="coin-flip-shimmer-85750.mp3" type="audio/mpeg">
</audio>

<audio id="bgm" loop preload="auto">
  <source src="S.mp3" type="audio/mpeg">
</audio>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const coin = document.getElementById('coin');
  const flipButton = document.getElementById('flip-button');
  const result = document.getElementById('result');
  const aCount = document.getElementById('a-count');
  const bCount = document.getElementById('b-count');
  const totalCount = document.getElementById('total-count');
  const emojisContainer = document.getElementById('emojis-container');
  const flipSound = document.getElementById('flip-sound');
  const muteBtn = document.getElementById('mute-btn');
  const muteIcon = document.getElementById('mute-icon');
  const unmuteIcon = document.getElementById('unmute-icon');
  const bgm = document.getElementById('bgm');
  const dimOverlay = document.getElementById('dim-overlay');

  const effectBtn = document.getElementById('effect-btn');
  const effectOn = document.getElementById('effect-on');
  const effectOff = document.getElementById('effect-off');

  // Game app elements
  const gameApp = document.getElementById('game-app');
  const gameBtn = document.getElementById('game-btn');
  const backBtn = document.getElementById('back-btn');
  const gameMuteBtn = document.getElementById('game-mute-btn');
  const gameMuteIcon = document.getElementById('game-mute-icon');
  const gameUnmuteIcon = document.getElementById('game-unmute-icon');
  const gameEffectBtn = document.getElementById('game-effect-btn');
  const gameEffectOn = document.getElementById('game-effect-on');
  const gameEffectOff = document.getElementById('game-effect-off');

  let effectsEnabled = true; // start OFF every time
  let isMuted = true;
  flipSound.muted = true;
  bgm.muted = true;
  muteIcon.style.display = 'block';
  unmuteIcon.style.display = 'none';
  effectOn.style.display = 'block';
  effectOff.style.display = 'none';
  effectBtn.classList.toggle('active', effectsEnabled);

  // Game app mute and effect state
  gameMuteIcon.style.display = 'block';
  gameUnmuteIcon.style.display = 'none';
  gameEffectOn.style.display = 'block';
  gameEffectOff.style.display = 'none';
  gameEffectBtn.classList.toggle('active', effectsEnabled);

  // --- GAME APP TOGGLE ---
  gameBtn.addEventListener('click', () => {
    gameApp.style.display = 'block';
    // Initialize the game if not already done
    if (typeof initGame === 'function') {
      initGame();
    }
  });

  backBtn.addEventListener('click', () => {
    gameApp.style.display = 'none';
  });

  // --- EFFECT TOGGLE ---
  function toggleEffects() {
    effectsEnabled = !effectsEnabled;
    effectOn.style.display = effectsEnabled ? 'block' : 'none';
    effectOff.style.display = effectsEnabled ? 'none' : 'block';
    effectBtn.classList.toggle('active', effectsEnabled);
    
    // Sync with game app effects
    gameEffectOn.style.display = effectsEnabled ? 'block' : 'none';
    gameEffectOff.style.display = effectsEnabled ? 'none' : 'block';
    gameEffectBtn.classList.toggle('active', effectsEnabled);
  }

  effectBtn.addEventListener('click', toggleEffects);
  gameEffectBtn.addEventListener('click', toggleEffects);

  // --- BGM AUTOPLAY ---
  function tryPlayBgm() {
    bgm.volume = 0.07;
    bgm.play().catch(() => {
      const resume = () => {
        bgm.play().catch(()=>{});
        document.removeEventListener('touchstart', resume);
        document.removeEventListener('click', resume);
      };
      document.addEventListener('touchstart', resume, { once: true });
      document.addEventListener('click', resume, { once: true });
    });
  }
  tryPlayBgm();

  // --- MUTE BUTTON ---
  function toggleMute() {
    isMuted = !isMuted;
    muteIcon.style.display = isMuted ? 'block' : 'none';
    unmuteIcon.style.display = isMuted ? 'none' : 'block';
    muteBtn.classList.toggle('active', !isMuted);
    flipSound.muted = isMuted;
    bgm.muted = isMuted;
    
    // Sync with game app mute
    gameMuteIcon.style.display = isMuted ? 'block' : 'none';
    gameUnmuteIcon.style.display = isMuted ? 'none' : 'block';
    gameMuteBtn.classList.toggle('active', !isMuted);
  }

  muteBtn.addEventListener('click', toggleMute);
  gameMuteBtn.addEventListener('click', toggleMute);

  // --- CONFETTI ---
  function createConfetti() {
    for (let i = 0; i < 120; i++) {
      const confetti = document.createElement('div');
      confetti.classList.add('confetti');
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.top = '-10vh';
      confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
      confetti.style.setProperty('--xShift', (Math.random() * 200 - 100) + 'px');
      confetti.style.animationDelay = (Math.random() * 0.8) + 's';
      confetti.style.animationDuration = (2.5 + Math.random() * 1.5) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 2500);
    }
  }

  // --- RAIN ---
  const thunderAudio = new Audio('thunder-soft.mp3');
  thunderAudio.volume = 0.3;
  function createRainScene() {
    document.body.classList.add('raining');
    dimOverlay.style.opacity = '1';
    const rainContainer = document.createElement('div');
    rainContainer.classList.add('rain-container');
    document.body.appendChild(rainContainer);

    for (let i = 0; i < 70; i++) {
      const drop = document.createElement('div');
      drop.classList.add('raindrop');
      drop.style.left = Math.random() * 100 + 'vw';
      drop.style.animationDuration = (0.7 + Math.random() * 0.6) + 's';
      drop.style.animationDelay = Math.random() + 's';
      rainContainer.appendChild(drop);
    }

    if (!isMuted) {
      thunderAudio.currentTime = 0;
      thunderAudio.play().catch(()=>{});
    }

    setTimeout(() => {
      dimOverlay.style.opacity = '0';
      setTimeout(() => {
        document.body.classList.remove('raining');
        rainContainer.remove();
      }, 400);
    }, 2500);
  }

  // --- COIN FLIP ---
  let isFlipping = false, aCounter = 0, bCounter = 0, totalFlips = 0;
  
  const cuteEmojis=['❤️','✨','🌟','🥰','😊','🌸','💫','🎀','💖','🦋','🐰','🐱','🐶','🌈','🎈','🎵','💕','💝','💘','💓','💗','💞','💟','❣️','⭐','🌺','🌷','💐','🌼','🦄','🍀','🎂','🍬','🍭','🎁','🎀','👑','💎','🔮','🎵'];

    function createEmojis(){
        for(let i=0;i<25;i++){
            const emoji=document.createElement('div');
            emoji.className='emoji';
            emoji.innerHTML=cuteEmojis[Math.floor(Math.random()*cuteEmojis.length)];
            emoji.style.left=Math.random()*100+'vw';
            emoji.style.animationDelay=Math.random()*8+'s';
            emoji.style.fontSize=(Math.random()*20+15)+'px';
            emoji.style.animation=`float ${8+Math.random()*6}s linear infinite`;
            emojisContainer.appendChild(emoji);
        }
    }
  createEmojis();

  const canvas = document.getElementById('splash-particles');
  const ctx = canvas.getContext('2d');
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  let particles = Array.from({ length:120 }, () => ({
    x: Math.random() * innerWidth,
    y: Math.random() * innerHeight,
    r: Math.random() * 2 + 1,
    dx: (Math.random() - 0.5) * 0.3,
    dy: (Math.random() - 0.5) * 0.3,
  }));

  function drawParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    for (let p of particles) {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();
      p.x += p.dx; p.y += p.dy;
      if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
    }
    requestAnimationFrame(drawParticles);
  }
  drawParticles();
  
  flipButton.addEventListener('click', function() {
    if (isFlipping) return;
    isFlipping = true;
    flipButton.disabled = true;
    result.textContent = "翻转中...";

    if (!isMuted) {
      flipSound.pause();
      flipSound.currentTime = 0;
      // Force a small reflow tick to ensure reset on iOS
      requestAnimationFrame(() => flipSound.play().catch(()=>{}));
    }

    const isA = Math.random() < 0.5;
    const fullSpins = 5;
    const finalAngle = isA ? 0 : 180;
    const totalRotation = 360 * fullSpins + finalAngle;
    coin.style.transition = 'transform 2s cubic-bezier(0.25, 1, 0.5, 1)';
    coin.style.transform = `rotateY(${totalRotation}deg)`;

    setTimeout(() => {
  coin.style.transition = 'none';
  coin.style.transform = `rotateY(${finalAngle}deg)`;
  if (isA) {
    result.innerHTML = "是 <strong>A</strong>！";
    aCounter++; aCount.textContent = aCounter;
    if (effectsEnabled) createConfetti();
  } else {
    result.innerHTML = "是 <strong>傻B :(</strong>";
    bCounter++; bCount.textContent = bCounter;
    if (effectsEnabled) createRainScene();
  }
  result.classList.add('celebrate');
  setTimeout(() => result.classList.remove('celebrate'), 500);
  totalFlips++; totalCount.textContent = totalFlips;

  // Enable button immediately if effects are disabled
  if (!effectsEnabled) {
    isFlipping = false;
    flipButton.disabled = false;
  }
  // If effects are enabled, wait for animation to end
  else {
    setTimeout(() => {
      isFlipping = false;
      flipButton.disabled = false;
    }, 3000); // Wait longer for effects to finish
  }
}, 2000);
  });

  // --- Prevent iOS double-tap zoom ---
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) event.preventDefault();
    lastTouchEnd = now;
  }, false);
});

// Game initialization function
function initGame() {
  // Set CSS variables for the game
  document.documentElement.style.setProperty('--cell-size', '28px');
  document.documentElement.style.setProperty('--board-size', '15');
  document.documentElement.style.setProperty('--grid-color', '#6d4c2b');
  document.documentElement.style.setProperty('--board-color', '#e2c49f');
  document.documentElement.style.setProperty('--star-point-size', '4px');
  document.documentElement.style.setProperty('--panel-pad', '10px');
  document.documentElement.style.setProperty('--control-w', '220px');
  
  // Initialize the game here
  // This would contain the entire Gomoku game code from your original file
  // For brevity, I'm not including the full Firebase integration here
  // but it would be placed in this function
}
</script>

<!-- Firebase and Gomoku game script -->
<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, onValue, update, get, push, runTransaction, onDisconnect, off } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

/* ---------- Firebase config (unchanged) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCUkxMlN4UH7viDG65qUwHlpJPyX4HrG_k",
  authDomain: "gomoku-f5642.firebaseapp.com",
  databaseURL: "https://gomoku-f5642-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "gomoku-f5642",
  storageBucket: "gomoku-f5642.firebasestorage.app",
  messagingSenderId: "565669580117",
  appId: "1:565669580117:web:6ffc82f164aa55bf0f73dc",
  measurementId: "G-1KXD1TVC8S"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ---------- UI refs ---------- */
const boardEl = document.getElementById("board");
const gridLinesEl = document.getElementById("gridLines");
const statusEl = document.getElementById("status");
const playersEl = document.getElementById("players");
const turnEl = document.getElementById("turnIndicator");
const youEl = document.getElementById("youIndicator");
const roomInput = document.getElementById("roomId");
const createBtn = document.getElementById("createBtn");
const joinBtn = document.getElementById("joinBtn");
const resetBtn = document.getElementById("resetBtn");
const leaveBtn = document.getElementById("leaveBtn");
const toast = document.getElementById("toast");
const initialButtons = document.getElementById("initialButtons");
const inRoomButtons = document.getElementById("inRoomButtons");
const boardContainer = document.getElementById("boardContainer");

const SIZE = 15;

/* ---------- state ---------- */
let localUID = null, roomId = null, unsubscribeRoom = null;
let role = null, board = Array(SIZE).fill(null).map(()=>Array(SIZE).fill(null));
let turn = "black", status = "idle";
let roomOwner = null;

/* ---------- Authentication ---------- */
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, user => {
  if (user) { localUID = user.uid; statusEl.textContent = "Connected (anon) — ready"; }
  else { localUID = null; statusEl.textContent = "Not connected"; }
});

/* ---------- Toast helper ---------- */
let toastTimer = null;
function showToast(msg, time=2200){
  if(toastTimer) clearTimeout(toastTimer);
  toast.textContent = msg;
  toast.classList.add("show");
  toastTimer = setTimeout(()=> toast.classList.remove("show"), time);
}

/* ---------- Responsive cell size calculation ---------- */
function fitBoardToViewport(){
  // Determine space for board so entire UI fits (controls panel on left or stacked)
  const safeW = window.innerWidth - 24; // padding
  const safeH = window.innerHeight - 24;
  // measure controls width (computed)
  const controlsRect = document.querySelector('.controls').getBoundingClientRect();
  const controlsW = (window.innerWidth > 900) ? controlsRect.width + 24 : 0; // when side-by-side, subtract controls
  // available for board
  const availableW = Math.max(120, safeW - controlsW - 40); // 40 margin between panels
  const availableH = safeH - 120; // leave some vertical space for header/status
  const avail = Math.min(availableW, availableH);
  // board dimension is (SIZE - 1) * cell
  const cell = Math.floor(avail / (SIZE - 1));
  const finalCell = Math.max(12, Math.min(32, cell)); // clamp to reasonable size
  document.documentElement.style.setProperty('--cell-size', finalCell + 'px');
  // also ensure board container uses this size (CSS uses var so reactive)
}
window.addEventListener('resize', fitBoardToViewport);
window.addEventListener('orientationchange', fitBoardToViewport);
setTimeout(fitBoardToViewport, 50);

/* ---------- Render board ---------- */
function renderBoard() {
  gridLinesEl.innerHTML = "";
  for(let i=0;i<SIZE-1;i++){
    const h=document.createElement("div");
    h.className="grid-line horizontal"; h.style.top=`calc(${i} * var(--cell-size))`;
    gridLinesEl.appendChild(h);
    const v=document.createElement("div");
    v.className="grid-line vertical"; v.style.left=`calc(${i} * var(--cell-size))`;
    gridLinesEl.appendChild(v);
  }

  boardEl.innerHTML = "";
  const stars=[[3,3],[3,11],[7,7],[11,3],[11,11]];
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const intersection=document.createElement("div");
      intersection.className="intersection"; intersection.dataset.r=r; intersection.dataset.c=c;
      if(stars.some(([rr,cc])=>rr===r&&cc===c)){
        const sp=document.createElement("div"); sp.className="star-point"; intersection.appendChild(sp);
      }
      const val=board[r][c];
      if(val){
        const s=document.createElement("div"); s.className="stone "+val; intersection.appendChild(s);
        intersection.classList.add("disabled");
      }
      intersection.addEventListener("click",onCellClick);
      boardEl.appendChild(intersection);
    }
  }
  turnEl.textContent="Turn: "+(turn||"—");
  youEl.textContent="You: "+(role||"—");
}

/* ---------- Cell click handler (keeps firebase logic intact) ---------- */
function onCellClick(e){
  const r = +e.currentTarget.dataset.r, c = +e.currentTarget.dataset.c;
  if(status !== "playing"){ 
    if(status && status.endsWith("-won")) showToast("Game over — reset to play again");
    else showToast("Join or create a room first"); 
    return; 
  }
  if(role !== turn){ showToast("Not your turn"); return; }
  if(board[r][c]) return;
  // push move to firebase (exactly like before)
  const path = `rooms/${roomId}/moves`;
  set(push(ref(db, path)), { r, c, color: role, by: localUID, ts: Date.now() });
}

/* ---------- Room lifecycle ---------- */
createBtn.onclick = async () => { const id = genCode(); roomInput.value = id; await createRoom(id); };
joinBtn.onclick = async () => { const id = roomInput.value.trim(); if(!id){ showToast("Enter a room code"); return;} await joinRoom(id); };
resetBtn.onclick = async () => {
  if(!roomId){ showToast("No active room"); return; }
  if(localUID !== roomOwner){ showToast("Only room creator can reset"); return; }
  await set(ref(db, `rooms/${roomId}`), emptyRoom({ owner: localUID }));
  showToast("Board reset");
};
leaveBtn.onclick = () => leaveRoom();

function genCode(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }
function emptyRoom(extra={}){ return Object.assign({ createdAt: Date.now(), size: SIZE, turn: "black", players: {}, moves: {} }, extra); }

async function createRoom(id){
  const rRef = ref(db, `rooms/${id}`);
  const snap = await get(rRef);
  if(snap.exists()){
    showToast("Room exists, joining…");
  } else {
    // set owner here so we know who can reset
    await set(rRef, emptyRoom({ owner: localUID }));
    showToast("Room created");
  }
  await joinRoom(id);
}

async function joinRoom(id){
  if(!localUID){ showToast("Not authenticated yet"); return; }
  roomId = id;
  const playersRef = ref(db, `rooms/${roomId}/players`);
  let assigned = "spectator";
  await runTransaction(playersRef, p => {
    if(!p) p = {};
    if(!p.black){ p.black = localUID; assigned = "black"; }
    else if(!p.white && p.black !== localUID){ p.white = localUID; assigned = "white"; }
    else if(p.black === localUID) assigned = "black";
    else if(p.white === localUID) assigned = "white";
    else assigned = "spectator";
    return p;
  });
  role = assigned;
  if(role === "black" || role === "white") onDisconnect(ref(db, `rooms/${roomId}/players/${role}`)).remove();

  // unsubscribe previous
  if(unsubscribeRoom){ off(ref(db, `rooms/${roomId}`)); unsubscribeRoom = null; }

  // listen to room
  onValue(ref(db, `rooms/${roomId}`), snap => applyUpdate(snap.val()));
  status = "playing";
  updateStatus();
  renderBoard();
  showToast(`Joined as ${role}`);
  // UI toggle
  initialButtons.style.display = "none";
  inRoomButtons.style.display = "flex";
  fitBoardToViewport();
}

/* ---------- FIXED leaveRoom: use set(..., null) instead of update(..., null) ---------- */
async function leaveRoom(){
  if(!roomId) return;
  const thisRoom = roomId;

  // If player occupied a slot, attempt to clear it (use set(..., null) which is valid).
  try{
    if(role === "black" || role === "white"){
      await set(ref(db, `rooms/${thisRoom}/players/${role}`), null);
    }
  }catch(err){
    console.error("Failed to clear player slot on leave:", err);
  }

  // Remove realtime listener for this room
  off(ref(db, `rooms/${thisRoom}`));

  // Reset local state and UI (ONLY UI & local state changes — game & other firebase logic untouched)
  roomId = null;
  role = null;
  status = "idle";
  roomOwner = null;

  // Clear local board and re-render empty board
  board = Array(SIZE).fill(null).map(()=>Array(SIZE).fill(null));
  renderBoard();
  updateStatus();

  // Reset UI controls to initial view
  initialButtons.style.display = "flex";
  inRoomButtons.style.display = "none";

  // Disable reset (no active room)
  resetBtn.disabled = true;

  // Clear inputs / indicators
  roomInput.value = "";
  playersEl.textContent = "Players: -";
  turnEl.textContent = "Turn: —";
  youEl.textContent = "You: —";
  statusEl.textContent = "Not connected";

  showToast("Left room");
}

/* ---------- Apply room updates from firebase (kept game logic) ---------- */
async function applyUpdate(data){
  if(!data) return;
  // set owner if present
  if(data.owner) roomOwner = data.owner;
  else roomOwner = data.createdBy || null;

  // reset local board and load moves
  board = Array(SIZE).fill(null).map(()=>Array(SIZE).fill(null));
  if(data.moves){
    // sort by ts to maintain order
    Object.values(data.moves).sort((a,b)=>a.ts-b.ts).forEach(m=>{
      if(m && m.r!=null && !board[m.r][m.c]) board[m.r][m.c] = m.color;
    });
  }
  // set turn from DB or derive
  turn = data.turn || getTurn(data.moves);
  // set local status to DB status if any (this allows blocking after a win)
  status = data.status || "playing";
  // update players text
  const p = data.players || {};
  playersEl.textContent = `Players: black=${p.black||"—"} white=${p.white||"—"}`;

  // update owner-based reset button visibility/enabled
  if(roomOwner && localUID){
    resetBtn.disabled = (localUID !== roomOwner);
  } else {
    resetBtn.disabled = true;
  }

  renderBoard();

  // process latest move for win detection and turn updates (kept unchanged)
  const movesArr = data.moves ? Object.values(data.moves).sort((a,b)=>a.ts-b.ts) : [];
  if(movesArr.length){
    const last = movesArr[movesArr.length-1];
    // check for win using local board state
    const win = checkWin(board, last.r, last.c, last.color);
    if(win && (!data.status || !data.status.endsWith("-won"))){
      // update DB status and winner (original code did this)
      await update(ref(db, `rooms/${roomId}`), { status: last.color + "-won", winner: last.color });
      showToast(`🏆 ${last.color.toUpperCase()} wins!`);
    } else if(!win){
      const next = last.color === "black" ? "white" : "black";
      // keep turn consistent in DB
      if(data.turn !== next){
        await update(ref(db, `rooms/${roomId}`), { turn: next }).catch(()=>{});
      }
      if(localUID && role === next) showToast("Your turn!");
    }
  }
  updateStatus();
}

/* ---------- helper functions (kept intact) ---------- */
function getTurn(m){ if(!m) return "black"; const n = Object.keys(m).length; return n%2===0?"black":"white"; }
function checkWin(bd, r, c, color){ if(!color) return false;
  const dirs = [[1,0],[0,1],[1,1],[1,-1]];
  for(const [dR,dC] of dirs){ let n = 1; n += count(bd,r,c,dR,dC,color); n += count(bd,r,c,-dR,-dC,color); if(n >= 5) return true; }
  return false;
}
function count(bd, r, c, dR, dC, color){
  let i = 1, n = 0;
  while(true){
    const nr = r + dR * i, nc = c + dC * i;
    if(nr < 0 || nr >= SIZE || nc < 0 || nc >= SIZE || bd[nr][nc] !== color) break;
    n++; i++;
  }
  return n;
}

/* Update status text */
function updateStatus(){
  statusEl.textContent = (status === "playing") ? "In Room" : (status && status.endsWith("-won") ? `Ended: ${status.replace("-won"," won")}` : "Not connected");
  // if ended, disable local placing via class toggling on board intersections happens in renderBoard
}

/* initial render */
renderBoard();
fitBoardToViewport();

</script>

</body>
</html>
